package controllers.admin

import play.api.mvc._
import play.api.libs.json._
import domain.malts.repositories.MaltReadRepository
import javax.inject.{Inject, Singleton}
import scala.concurrent.{ExecutionContext, Future}

@Singleton  
class AdminMaltsController @Inject()(
  val controllerComponents: ControllerComponents,
  maltReadRepository: MaltReadRepository
)(implicit ec: ExecutionContext) extends BaseController {

  def list(
    page: Int = 0,
    pageSize: Int = 20,
    maltType: Option[String] = None,
    status: Option[String] = None,
    source: Option[String] = None,
    minCredibility: Option[Int] = None,
    needsReview: Boolean = false,
    searchTerm: Option[String] = None,
    sortBy: String = "name",
    sortOrder: String = "asc"
  ): Action[AnyContent] = Action.async { implicit request =>
    
    for {
      malts <- maltReadRepository.findAll(page, pageSize, activeOnly = true)
      totalCount <- maltReadRepository.count(activeOnly = true)
    } yield {
      val maltJson = malts.map(malt => Json.obj(
        "id" -> malt.id.value,
        "name" -> malt.name.value,
        "maltType" -> malt.maltType.name,
        "ebcColor" -> malt.ebcColor.value,
        "extractionRate" -> malt.extractionRate.value,
        "diastaticPower" -> malt.diastaticPower.value,
        "originCode" -> malt.originCode,
        "description" -> malt.description,
        "flavorProfiles" -> malt.flavorProfiles,
        "source" -> malt.source.name,
        "isActive" -> malt.isActive,
        "credibilityScore" -> malt.credibilityScore,
        "createdAt" -> malt.createdAt.toString,
        "updatedAt" -> malt.updatedAt.toString,
        "version" -> malt.version
      ))
      
      Ok(Json.obj(
        "malts" -> maltJson,
        "pagination" -> Json.obj(
          "currentPage" -> page,
          "pageSize" -> pageSize,
          "totalCount" -> totalCount,
          "hasNext" -> ((page + 1) * pageSize < totalCount)
        )
      ))
    }
  }

  // Stubs pour les autres méthodes
  def create(): Action[AnyContent] = Action { 
    BadRequest(Json.obj("error" -> "Création non implémentée"))
  }
  
  def detail(id: String, includeAuditLog: Boolean = false, includeSubstitutes: Boolean = true, 
             includeBeerStyles: Boolean = true, includeStatistics: Boolean = false): Action[AnyContent] = Action {
    NotImplemented(Json.obj("error" -> "Détail non implémenté"))
  }
  
  def update(id: String): Action[AnyContent] = Action { 
    NotImplemented(Json.obj("error" -> "Mise à jour non implémentée")) 
  }
  
  def delete(id: String): Action[AnyContent] = Action { 
    NotImplemented(Json.obj("error" -> "Suppression non implémentée")) 
  }
  
  def statistics(): Action[AnyContent] = Action { 
    NotImplemented(Json.obj("error" -> "Statistiques non implémentées")) 
  }
  
  def needsReview(page: Int = 0, pageSize: Int = 20, maxCredibility: Int = 70): Action[AnyContent] = Action {
    NotImplemented(Json.obj("error" -> "Révision non implémentée"))
  }
  
  def adjustCredibility(id: String): Action[AnyContent] = Action {
    NotImplemented(Json.obj("error" -> "Ajustement crédibilité non implémenté"))
  }
  
  def batchImport(): Action[AnyContent] = Action {
    NotImplemented(Json.obj("error" -> "Import batch non implémenté"))
  }
}
